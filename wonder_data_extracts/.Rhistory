theme_bw()
p2 = ggplot(subset(diamonds, carat > 2.2 & depth > 55 & depth < 70),
aes(x = depth, fill = cut)) +
geom_histogram(colour = "black", binwidth = 1, position = "dodge") +
theme_bw()
p1 + scale_color_d3()
p2 + scale_fill_d3()
library("ggsci")
p1 + scale_color_d3()
vignette("ggsci")
library(RCurl)
#load most recent rallies report.
setwd("C:/Users/smits/Documents/RallyMe/Dashboard/rallymeVis")
#load most recent rallies report.
setwd("C:/Users/smits/Documents/RallyMe/Dashboard/rallymeVis")
getwd()
#load most recent rallies report.
setwd("C:/Users/smits/Documents/RallyMe/Dashboard/rallymeVis")
#load most recent rallies report.
setwd("C:/Users/smits/Documents/RallyMe/Dashboard/rallymeVis"
getwd()
shiny::runApp(appDir = system.file("shiny/crimes", package = "ggiraph"), display.mode = "showcase")
shiny::runApp(appDir = system.file("shiny/cars", package = "ggiraph"), display.mode = "showcase")
shiny::runApp(appDir = system.file("shiny/iris", package = "ggiraph"), display.mode = "showcase")
shiny::runApp(appDir = system.file("shiny/iris", package = "ggiraph"), display.mode = "showcase")
shiny::runApp(appDir = system.file("shiny/crimes", package = "ggiraph"), display.mode = "showcase")
# initialize libraries
library(shiny)
library(plyr)
library(dplyr)
library(ggplot2)
library(rgdal)    # for readOGR(...)
library(maptools)
library(data.table)
library(mapproj)
library(RColorBrewer) # for brewer.pal(...)
library(plotly)
library(stringr)      # for str_detect(...)
library(ggthemes)
library(shinyWidgets)
library(ggiraph)      # for Geom_polygon_interactive(...)
library(tools)        # for toTitleCase(...)
setwd("C:/Users/smits/Documents/GitHub/delivery_method")
#import some data
# Note, you have to delete the comments at the end of the text files.
# due to supression, the totals likely won't be able to be calculated when
# you include segments.
# age and race - use this for the analysis of race and age.
natality_race_age<- read.delim("wonder_data_extracts/Natality_12_15_race_age_v2.txt",
header = TRUE, colClasses = "character")
race_age<- natality_race_age %>%
mutate(Births = as.numeric(Births)) %>%
group_by(County.Code, Race.Code, Age.of.Mother.9.Code) %>%
mutate(cesarean_rate = Births/sum(Births),
Race = factor(Race, levels=c("American Indian or Alaska Native",
"Asian or Pacific Islander",
"White",
"Black or African American"),
ordered = TRUE)) %>%
filter(Delivery.Method == "Cesarean")
# county totals, all births
natality<- read.delim("wonder_data_extracts/Natality_12_15_county_totals_all_births_v2.txt",
header = TRUE, colClasses = "character") %>%
filter(Births != "Suppressed") %>%
mutate(Births = as.numeric(Births)) %>%
group_by(County.Code, County) %>%
mutate(cesarean_rate_all = round(Births/sum(Births),4)*100,
births_all = sum(Births)) %>%
filter(Delivery.Method == "Cesarean") %>%
select(-Notes, -Births, -Delivery.Method, -Delivery.Method.Code)
# population totals for counties
# https://www.census.gov/data/datasets/2016/demo/popest/counties-total.html#ds
setwd("C:/Users/smits/Documents/GitHub/delivery_method/")
county.pop <- read.csv("co-est2016-alldata.csv", colClasses = "character") %>%
mutate(fips = paste0(STATE, COUNTY),
state = toTitleCase(STNAME),
county = gsub(" county", "", tolower(CTYNAME)))%>%
mutate(county=gsub(" parish", "", tolower(county))) %>% # because louisiana is weird
mutate(county=gsub("[.]", "", county)) %>%  # in the ggplot map data, they don't have periods
select(fips, POPESTIMATE2012, state, county) %>%
filter(substr(fips,3,5) != '000')  #this was super exagerating the population!
#join in unidentified counties so taht we can join by state
unidentified<- filter(natality, str_detect(County, "Unidentified")) %>%
mutate(state_code = substr(County.Code, 1,2))
natality.2<- county.pop %>%
left_join(natality, by=c("fips" = "County.Code")) %>%
mutate(fips_state = substr(fips,1,2)) %>%
left_join(unidentified, by = c("fips_state" = "state_code")) %>%
mutate(county_display = ifelse(is.na(County.x), County.y, County.x),
cesarean_rate = ifelse(is.na(cesarean_rate_all.x), cesarean_rate_all.y, cesarean_rate_all.x),
births = ifelse(is.na(births_all.x), births_all.y, births_all.x),
population = as.numeric(POPESTIMATE2012)) %>%
group_by(county_display) %>%
mutate(population_display = sum(population),
fips = ifelse(fips == "46102", "46113", fips)) %>%
select(fips,                     #take only the variables I need going forward
county_display,
cesarean_rate,
births,
population,
population_display,
state,
county)
# check that we have cesarean rates for all counties with >100,000 2013 pop
#unidentified_check<- filter(counties_3, population<100000)
# check population sums
#unidentified_check<- filter(counties_3, state == 'Alabama')
us.counties <- readOGR(dsn=".",layer="cb_2016_us_county_5m")
us.counties<- us.counties[!us.counties$STATEFP %in% exclude_states,]
us_counties<-fortify(us.counties)
#new mapping way
#https://www2.census.gov/geo/tiger/GENZ2016/shp/cb_2016_us_county_5m.zip
setwd("C:/Users/smits/Documents/GitHub/delivery_method/wonder_data_extracts")
us.counties <- readOGR(dsn=".",layer="cb_2016_us_county_5m")
us.counties<- us.counties[!us.counties$STATEFP %in% exclude_states,]
us_counties<-fortify(us.counties)
View(us_counties)
#new mapping way
#https://www2.census.gov/geo/tiger/GENZ2016/shp/cb_2016_us_county_5m.zip
exclude_states<- c("02", "15", "78", "60", "66", "69", "72")
us.counties <- readOGR(dsn=".",layer="cb_2016_us_county_5m")
us.counties<- us.counties[!us.counties$STATEFP %in% exclude_states,]
View(us.counties)
#trying with the new way...
county.data <- us.counties@data
county.data <- us.counties@data
county.data <- data.table(county.data)
county.data <- data.table(county.data)
county.data[,FIPS:=paste0(STATE,COUNTY)] # this is the state + county FIPS code
setkey(county.data,FIPS)
county.data[,FIPS:=paste0(STATEFP,COUNTYFP)] # this is the state + county FIPS code
setkey(county.data,FIPS)
#join natality with county.pop
natality.3 <- data.table(natality.2)
setkey(natality.3,fips)
# join the natality data with the county data.
county.data <- county.data[natality.3]  # should be joined on fips
setkey(county.data, id)
#trying with the new way...
county.data <- us.counties@data
county.data <- cbind(id=rownames(county.data),county.data)
county.data <- data.table(county.data)
county.data[,FIPS:=paste0(STATEFP,COUNTYFP)] # this is the state + county FIPS code
setkey(county.data,FIPS)
#join natality with county.pop
natality.3 <- data.table(natality.2)
setkey(natality.3,fips)
natality.3 <- data.table(natality.2)
setkey(natality.3,fips)
county.data <- county.data[natality.3]  # should be joined on fips
setkey(county.data, id)
View(county.data)
#make the map layer
map.df<-fortify(us.counties)
setkey(map.df,id)
#make the map layer
map.df<-data.table(fortify(us.counties))
setkey(map.df,id)
# add in interesting data
map.df<- map.df[county.data]  # should be joined on ID
ggplot(map.df, aes(x=long, y=lat, group = group)) +
geom_polygon( aes( fill = cesarean_rate)) +
coord_quickmap()+
theme_void()+
geom_path(data = state_map, colour="black") +
scale_fill_gradientn("",colours=brewer.pal(9,"YlGnBu"))
ggplot(map.df, aes(x=long, y=lat, group = group)) +
geom_polygon( aes( fill = cesarean_rate)) +
coord_quickmap()+
theme_void()+
scale_fill_gradientn("",colours=brewer.pal(9,"YlGnBu"))
# use the TIGER dataset from the census to draw the state outlines
# http://www2.census.gov/geo/tiger/GENZ2016/shp/cb_2016_us_state_5m.zip
US.states <- readOGR(dsn=".",layer="cb_2016_us_state_5m")
exclude_states<- c("02", "15", "78", "60", "66", "69", "72")
US.states<- US.states[!US.states$GEOID %in% exclude_states,]
us_states<- fortify(US.states)
ggplot(map.df, aes(x=long, y=lat, group = group)) +
geom_polygon( aes( fill = cesarean_rate)) +
coord_quickmap()+
theme_void()+
geom_polygon(data = us_states, aes(x=long, y=lat, group = group), color = "black", fill = NA)
natality.2<- county.pop %>%
left_join(natality, by=c("fips" = "County.Code")) %>%
mutate(fips_state = substr(fips,1,2)) %>%
left_join(unidentified, by = c("fips_state" = "state_code")) %>%
mutate(county_display = ifelse(is.na(County.x), County.y, County.x),
cesarean_rate = ifelse(is.na(cesarean_rate_all.x), cesarean_rate_all.y, cesarean_rate_all.x),
births = ifelse(is.na(births_all.x), births_all.y, births_all.x),
population = as.numeric(POPESTIMATE2012)) %>%
group_by(county_display) %>%
mutate(population_display = sum(population),
# fips = ifelse(fips == "46102", "46113", fips)
) %>% #Damn county in SD
select(fips,                     #take only the variables I need going forward
county_display,
cesarean_rate,
births,
population,
population_display,
state,
county)
# ,fips = ifelse(fips == "46102", "46113", fips)
) %>% #Damn county in SD
select(fips,                     #take only the variables I need going forward
county_display,
cesarean_rate,
births,
population,
population_display,
state,
county)
natality.2<- county.pop %>%
left_join(natality, by=c("fips" = "County.Code")) %>%
mutate(fips_state = substr(fips,1,2)) %>%
left_join(unidentified, by = c("fips_state" = "state_code")) %>%
mutate(county_display = ifelse(is.na(County.x), County.y, County.x),
cesarean_rate = ifelse(is.na(cesarean_rate_all.x), cesarean_rate_all.y, cesarean_rate_all.x),
births = ifelse(is.na(births_all.x), births_all.y, births_all.x),
population = as.numeric(POPESTIMATE2012)) %>%
group_by(county_display) %>%
mutate(population_display = sum(population),
# fips = ifelse(fips == "46102", "46113", fips)
) %>% #Damn county in SD
select(fips,                     #take only the variables I need going forward
county_display,
cesarean_rate,
births,
population,
population_display,
state,
county)
natality.2<- county.pop %>%
left_join(natality, by=c("fips" = "County.Code")) %>%
mutate(fips_state = substr(fips,1,2)) %>%
left_join(unidentified, by = c("fips_state" = "state_code")) %>%
mutate(county_display = ifelse(is.na(County.x), County.y, County.x),
cesarean_rate = ifelse(is.na(cesarean_rate_all.x), cesarean_rate_all.y, cesarean_rate_all.x),
births = ifelse(is.na(births_all.x), births_all.y, births_all.x),
population = as.numeric(POPESTIMATE2012)) %>%
group_by(county_display) %>%
mutate(population_display = sum(population)
# ,fips = ifelse(fips == "46102", "46113", fips)
) %>% #Damn county in SD
select(fips,                     #take only the variables I need going forward
county_display,
cesarean_rate,
births,
population,
population_display,
state,
county)
#new mapping way
#https://www2.census.gov/geo/tiger/GENZ2016/shp/cb_2016_us_county_5m.zip
exclude_states<- c("02", "15", "78", "60", "66", "69", "72")
#excludes Alaska, american samoa (60), commonwealth of the northern mariana islands (69),
# guam (66). need to exclude the virgin islands
setwd("C:/Users/smits/Documents/GitHub/delivery_method/wonder_data_extracts")
us.counties <- readOGR(dsn=".",layer="cb_2016_us_county_5m")
us.counties<- us.counties[!us.counties$STATEFP %in% exclude_states,]
#trying with the new way...
county.data <- us.counties@data
county.data <- cbind(id=rownames(county.data),county.data)
county.data <- data.table(county.data)
county.data[,FIPS:=paste0(STATEFP,COUNTYFP)] # this is the state + county FIPS code
setkey(county.data,FIPS)
# join the natality data with the county data.
natality.3 <- data.table(natality.2)
setkey(natality.3,fips)
county.data <- county.data[natality.3]  # should be joined on fips
setkey(county.data, id)
# make the map layer
map.df<-data.table(fortify(us.counties))
setkey(map.df,id)
# add in interesting data
map.df<- map.df[county.data]  # should be joined on ID
# use the TIGER dataset from the census to draw the state outlines
# http://www2.census.gov/geo/tiger/GENZ2016/shp/cb_2016_us_state_5m.zip
US.states <- readOGR(dsn=".",layer="cb_2016_us_state_5m")
exclude_states<- c("02", "15", "78", "60", "66", "69", "72")
US.states<- US.states[!US.states$GEOID %in% exclude_states,]
us_states<- fortify(US.states)
ggplot(map.df, aes(x=long, y=lat, group = group)) +
geom_polygon( aes( fill = cesarean_rate)) +
coord_quickmap()+
theme_void()+
geom_polygon(data = us_states, aes(x=long, y=lat, group = group), color = "black", fill = NA)
names(us_states)
# take the filtered data from the reactive portion above
ggplot(map.df, aes(x=long, y=lat, group = group)) +
geom_polygon( aes( fill = cesarean_rate)) +
coord_quickmap()+
theme_void()+
scale_fill_gradientn("",colours=brewer.pal(9,"YlGnBu"))+
geom_polygon(data = us_states, aes(x=long, y=lat, group = group), color = "black", fill = NA)
names(map.df)
unique(map.df$state)
us_states<- fortify(US.states)
source('~/GitHub/delivery_method/delivery_method_app/app.R')
source('~/.active-rstudio-document')
runApp('ggiraph_sizing.R')
runApp('ggiraph_sizing.R')
library(ggplot2)
library(mapdata)
library(shiny)
library(data.table)
library(ggiraph)
map.county <- map_data('county')
counties<- data.table(map.county)
runApp('ggiraph_sizing.R')
runApp('ggiraph_sizing.R')
runApp('ggiraph_sizing.R')
runApp('ggiraph_sizing.R')
# just two states
p<- ggplot(counties[counties$region %in% c("alabama", "georgia"),], aes(x=long, y=lat, group = group)) +
# coord_map("polyconic" ) +  # comment or uncomment this line to see the changes
theme(plot.margin = unit(c(.1,.1,.1,.1), "cm")) +
geom_polygon_interactive(aes(tooltip = subregion))
ggiraph(code = {print(p)},width = 1)
runApp('ggiraph_sizing.R')
head(map.df)
# Bring in the state names  for filtering
state_crosswalk<-map.df %>%
select(substr(FIPS,1,2), state)
# Bring in the state names  for filtering
state_crosswalk<-map.df %>%
select(FIPS, state) %>%
mutate(statefp<- substr(FIPS,1,2))
View(state_crosswalk)
# Bring in the state names  for filtering
state_crosswalk<-map.df %>%
select(FIPS, state) %>%
mutate(statefp<- substr(FIPS,1,2)) %>%
select (statefp, state)
# Bring in the state names  for filtering
state_crosswalk<-map.df %>%
select(FIPS, state) %>%
mutate(statefp<- substr(FIPS,1,2)) %>%
select(statefp, state)
# Bring in the state names  for filtering
state_crosswalk<-map.df %>%
select(FIPS, state) %>%
mutate(statefp= substr(FIPS,1,2)) %>%
select(statefp, state)
# Bring in the state names  for filtering
state_crosswalk<-map.df %>%
select(FIPS, state) %>%
mutate(statefp= substr(FIPS,1,2)) %>%
select(statefp, state) %>%
distinct()
View(state_crosswalk)
View(us_states)
table(us_states$id)
table(state_crosswalk$statefp)
# Bring in the state names  for filtering
state_crosswalk<-map.df %>%
select(FIPS, state) %>%
mutate(statefp = ifelse(substr(FIPS,1,1) == '0',
substr(FIPS,2,1),
substr(FIPS,1,2))) %>%
select(statefp, state) %>%
distinct()
table(state_crosswalk$statefp)
# Bring in the state names  for filtering
state_crosswalk<-map.df %>%
select(FIPS, state) %>%
mutate(statefp = ifelse(substr(FIPS,1,1) == '0',
substr(FIPS,2,2),
substr(FIPS,1,2))) %>%
select(statefp, state) %>%
distinct()
table(state_crosswalk$statefp)
View(US.states)
View(us.counties)
source('~/GitHub/delivery_method/delivery_method_app/app.R')
View(US.states)
View(us_states)
us_states<- data.table(fortify(US.states))
View(us_states)
View(us_states)
View(US.states)
us_states<- merge(fortify(US.states), as.data.frame(US.states), by.x="id", by.y=0)
View(us_states)
# take the filtered data from the reactive portion above
ggplot(map.df[map.df$state %in% input$select_state,], aes(x=long, y=lat, group = group)) +
geom_polygon( aes( fill = cesarean_rate)) +
coord_quickmap()+
theme_void()+
scale_fill_gradientn("",colours=brewer.pal(9,"YlGnBu"))+
geom_polygon(data = us_states[us_states$NAME %in% input$select_state, ]
, aes(x=long, y=lat, group = group), color = "black", fill = NA)
source('~/GitHub/delivery_method/delivery_method_app/app.R')
library(ggplot2)
library(mapdata)
map.county <- map_data('county')
counties<- data.table(map.county)
library(ggvis)
install.packages("ggvis")
library(ggvis)
ggplot(counties, aes(x=long, y=lat, group = group)) +
geom_polygon(colour = "grey") %>%
add_tooltip(function(counties) counties$region)
counties %>%
ggvis(~long, ~lat) %>%
group_by(group, id) %>%
layer_paths(strokeOpacity:=0.5, stroke:="#7f7f7f") %>%
hide_legend("fill") %>%
hide_axis("x") %>% hide_axis("y") %>%
set_options(width=400, height=600, keep_aspect=TRUE)
counties %>%
ggvis(~long, ~lat) %>%
group_by(group) %>%
layer_paths(strokeOpacity:=0.5, stroke:="#7f7f7f") %>%
hide_legend("fill") %>%
hide_axis("x") %>% hide_axis("y") %>%
set_options(width=400, height=600, keep_aspect=TRUE)
counties %>%
ggvis(~long, ~lat) %>%
group_by(group) %>%
layer_paths(strokeOpacity:=0.5, stroke:="#7f7f7f") %>%
hide_legend("fill") %>%
hide_axis("x") %>% hide_axis("y") %>%
set_options(width=400, height=600, keep_aspect=TRUE) %>%
add_tooltip(region, "hover")
source('~/GitHub/delivery_method/delivery_method_app/app.R')
source('~/GitHub/delivery_method/delivery_method_app/app.R')
source('~/GitHub/delivery_method/delivery_method_app/app.R')
p<- ggplot(map.df,  aes(x=long, y=lat, group = group)) +
geom_polygon( aes( fill = cesarean_rate)) +
coord_quickmap()+
theme_void()+
geom_polygon_interactive(aes(tooltip = paste0(gsub("'", "", county_display),
"<br>Population: ", format(population,big.mark=","),
"<br>Births: ", format(births, big.mark=","),
"<br>C-section Rate: ", cesarean_rate, "%")))+
scale_fill_gradientn("",colours=brewer.pal(9,"YlGnBu"))+
geom_polygon(data = us_state, aes(x=long, y=lat, group = group), color = "black", fill = NA)
ggiraph(code = print(p)) #takes a super long time to render...
p<- ggplot(map.df,  aes(x=long, y=lat, group = group)) +
geom_polygon( aes( fill = cesarean_rate)) +
coord_quickmap()+
theme_void()+
geom_polygon_interactive(aes(tooltip = paste0(gsub("'", "", county_display),
"<br>Population: ", format(population,big.mark=","),
"<br>Births: ", format(births, big.mark=","),
"<br>C-section Rate: ", cesarean_rate, "%")))+
scale_fill_gradientn("",colours=brewer.pal(9,"YlGnBu"))+
geom_polygon(data = us_states, aes(x=long, y=lat, group = group), color = "black", fill = NA)
ggiraph(code = print(p)) #takes a super long time to render...
# take the filtered data from the reactive portion above
p<- ggplot(map.df,  aes(x=long, y=lat, group = group)) +
geom_polygon( aes( fill = cesarean_rate)) +
coord_quickmap()+
theme_void()+
geom_polygon_interactive(aes(tooltip = paste0(gsub("'", "", county_display),
"<br>Population: ", format(population,big.mark=","),
"<br>Births: ", format(births, big.mark=","),
"<br>C-section Rate: ", cesarean_rate, "%")),
fill = cesarean_rate)+
scale_fill_gradientn("",colours=brewer.pal(9,"YlGnBu"))+
geom_polygon(data = us_states, aes(x=long, y=lat, group = group), color = "black", fill = NA)
head(map.df)
p<- ggplot(map.df,  aes(x=long, y=lat, group = group)) +
geom_polygon( aes( fill = cesarean_rate)) +
coord_quickmap()+
theme_void()+
geom_polygon_interactive(aes(tooltip = paste0(gsub("'", "", county_display),
"<br>Population: ", format(population,big.mark=","),
"<br>Births: ", format(births, big.mark=","),
"<br>C-section Rate: ", cesarean_rate, "%")
,
fill = cesarean_rate))+
scale_fill_gradientn("",colours=brewer.pal(9,"YlGnBu"))+
geom_polygon(data = us_states, aes(x=long, y=lat, group = group), color = "black", fill = NA)
ggiraph(code = print(p)) #takes a super long time to render...
source('~/GitHub/delivery_method/delivery_method_app/app.R')
source('~/GitHub/delivery_method/delivery_method_app/app.R')
source('~/GitHub/delivery_method/delivery_method_app/app.R')
sort(unique(us_states$NAME))
source('~/GitHub/delivery_method/delivery_method_app/app.R')
sort(unique(us_states$NAME)
)
sort(unique(map.df$state))
source('~/GitHub/delivery_method/delivery_method_app/app.R')
input$select_state <- c("Alabama", "Georgia")
input<-NULL
input$select_state <- c("Alabama", "Georgia")
View(input)
map.df[map.df$state %in% input$select_state,]
us_states[us_states$NAME %in% input$select_state, ]
source('~/GitHub/delivery_method/delivery_method_app/app.R')
# initialize libraries
library(shiny)
library(plyr)
library(dplyr)
library(ggplot2)
library(rgdal)    # for readOGR(...)
library(maptools)
library(data.table)
library(mapproj)
library(RColorBrewer) # for brewer.pal(...)
library(plotly)
library(stringr)      # for str_detect(...)
library(ggthemes)
library(shinyWidgets)
library(ggiraph)      # for Geom_polygon_interactive(...)
library(tools)        # for toTitleCase(...)
source('~/GitHub/delivery_method/delivery_method_app/app.R')
source('~/GitHub/delivery_method/delivery_method_app/app.R')
source('~/GitHub/delivery_method/delivery_method_app/app.R')
source('~/GitHub/delivery_method/delivery_method_app/app.R')
source('~/GitHub/delivery_method/delivery_method_app/app.R')
