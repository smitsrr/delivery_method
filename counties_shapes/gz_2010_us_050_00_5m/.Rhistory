# initialize libraries
library(shiny)
library(plyr)
library(dplyr)
library(ggplot2)
library(rgdal)    # for readOGR(...)
library(data.table)
library(mapproj)
library(RColorBrewer) # for brewer.pal(...)
library(plotly)
# move up one directory
setwd("..")
#import some data
# Note, you have to delete the comments at the end of the text files.
# due to supression, the totals likely won't be able to be calculated when
# you include segments.
natality<- read.delim("wonder_data_extracts/Natality_12_15_race_age_v2.txt",
header = TRUE, colClasses = "character")
#total county rates
natality_counties<- read.delim("wonder_data_extracts/Natality_12_15_county_totals_v2.txt",
header = TRUE, colClasses = "character") %>%
filter(Births != "Suppressed") %>%
mutate(Births = as.numeric(Births)) %>%
group_by(County.Code, County) %>%
mutate(cesarean_rate = Births/sum(Births),
births = sum(Births)) %>%
filter(Delivery.Method == "Cesarean") %>%
select(-Notes, -Births, -Delivery.Method, -Delivery.Method.Code)
# county and FIPS codes from https://www.census.gov/geo/reference/codes/cou.html
counties<- read.delim("national_county.txt", header = FALSE, sep = ",",
colClasses = "character")
counties_2<- counties %>%
rename_("state_code" = "V1",
"fips_state" = "V2",
"fips_county" = "V3",
"county_name" = "V4",
"fips_class" = "V5") %>%
mutate(fips = paste0(fips_state, fips_county))
# county and FIPS codes from https://www.census.gov/geo/reference/codes/cou.html
counties<- read.delim("national_county.txt", header = FALSE, sep = ",",
colClasses = "character")
counties_2<- counties %>%
rename_("state_code" = "V1",
"fips_state" = "V2",
"fips_county" = "V3",
"county_name" = "V4",
"fips_class" = "V5") %>%
mutate(fips = paste0(fips_state, fips_county))
# https://www.census.gov/data/datasets/2016/demo/popest/counties-total.html#ds
setwd("C:/Users/smits/Documents/GitHub/delivery_method/")
county.pop <- read.csv("co-est2016-alldata.csv", colClasses = "character") %>%
mutate(fips = paste0(STATE, COUNTY)) %>%
select(fips, POPESTIMATE2013, POPESTIMATE2014, POPESTIMATE2015)
names(counties_2)
names(county.pop)
counties_3<- left_join(counties_2, county.pop)
head(counties_3)
county.pop <- read.csv("co-est2016-alldata.csv", colClasses = "character") %>%
mutate(fips = paste0(STATE, COUNTY)) %>%
select(fips, POPESTIMATE2012)
counties_3<- left_join(counties_2, county.pop)
head(counties_3)
head(natality_counties)
#total county rates
natality_counties<- read.delim("wonder_data_extracts/Natality_12_15_county_totals_v2.txt",
header = TRUE, colClasses = "character") %>%
filter(Births != "Suppressed") %>%
mutate(Births = as.numeric(Births)) %>%
group_by(County.Code, County) %>%
mutate(cesarean_rate = round(Births/sum(Births),4)*100,
births = sum(Births)) %>%
filter(Delivery.Method == "Cesarean") %>%
select(-Notes, -Births, -Delivery.Method, -Delivery.Method.Code)
head(natality_counties)
names(counties_3)
counties_3<- left_join(counties_2, county.pop) %>%
left_join(natality_counties, by=c("fips" = "County.Code"))
View(counties_3)
table(natality_counties$County)
?grep
#join in unidentified counties
unidentified<- filter(natality_counties, grepl(County, "Unidentified")==TRUE)
View(unidentified)
#join in unidentified counties
unidentified<- filter(natality_counties, grepl(County, "Unidentified"))
#join in unidentified counties
unidentified<- filter(natality_counties, str_detect(County, "Unidentified"))
library(stringr)  # for str_detect(...)
#join in unidentified counties
unidentified<- filter(natality_counties, str_detect(County, "Unidentified"))
View(unidentified)
head(counties)
head(counties_2)
head(natality)
#total county rates
natality_counties<- read.delim("wonder_data_extracts/Natality_12_15_county_totals_v2.txt",
header = TRUE, colClasses = "character") %>%
filter(Births != "Suppressed") %>%
mutate(Births = as.numeric(Births)) %>%
group_by(County.Code, County, state_code) %>%
mutate(cesarean_rate = round(Births/sum(Births),4)*100,
births = sum(Births)) %>%
filter(Delivery.Method == "Cesarean") %>%
select(-Notes, -Births, -Delivery.Method, -Delivery.Method.Code)
#total county rates
natality_counties<- read.delim("wonder_data_extracts/Natality_12_15_county_totals_v2.txt",
header = TRUE, colClasses = "character") %>%
filter(Births != "Suppressed")
names(natality_counties)
#total county rates
natality_counties<- read.delim("wonder_data_extracts/Natality_12_15_county_totals_v2.txt",
header = TRUE, colClasses = "character") %>%
filter(Births != "Suppressed") %>%
mutate(Births = as.numeric(Births)) %>%
group_by(County.Code, County) %>%
mutate(cesarean_rate = round(Births/sum(Births),4)*100,
births = sum(Births)) %>%
filter(Delivery.Method == "Cesarean") %>%
select(-Notes, -Births, -Delivery.Method, -Delivery.Method.Code)
View(unidentified)
names(unidentified)
View(unidentified)
View(counties_3)
#join in unidentified counties
unidentified<- filter(natality_counties, str_detect(County, "Unidentified")) %>%
mutate(state_code = substr(County.Code, 1,2))
View(unidentified)
View(unidentified)
#join in unidentified counties
unidentified<- filter(natality_counties, str_detect(County, "Unidentified")) %>%
mutate(state_code = substr(County.Code, 1,2)) %>%
select(-County, -County.Code)
View(unidentified)
#join in unidentified counties
unidentified<- filter(natality_counties, str_detect(County, "Unidentified")) %>%
mutate(state_code = substr(County.Code, 1,2))
View(unidentified)
names(unidentified)
#join in unidentified counties
unidentified<- filter(natality_counties, str_detect(County, "Unidentified")) %>%
mutate(state_code = substr(County.Code, 1,2)) %>%
select(-County, -County.Code)
View(counties_3)
counties_3<- left_join(counties_2, county.pop) %>%
left_join(natality_counties, by=c("fips" = "County.Code")) %>%
left_join(unidentified, by = c("fips_state" = "state_code"))
View(natality_counties)
View(counties_3)
counties_3<- left_join(counties_2, county.pop) %>%
left_join(natality_counties, by=c("fips" = "County.Code")) %>%
left_join(unidentified, by = c("fips_state" = "state_code")) %>%
mutate(county.x = ifelse(is.na(county.x), county.y, county.x))
names(unidentified)
View(counties_3)
names(counties_3)
counties_3<- left_join(counties_2, county.pop) %>%
left_join(natality_counties, by=c("fips" = "County.Code")) %>%
left_join(unidentified, by = c("fips_state" = "state_code")) %>%
mutate(County.x = ifelse(is.na(County.x), County.y, County.x))
View(counties_3)
counties_3<- left_join(counties_2, county.pop) %>%
left_join(natality_counties, by=c("fips" = "County.Code")) %>%
left_join(unidentified, by = c("fips_state" = "state_code")) %>%
mutate(County.x = ifelse(is.na(County.x), County.y, County.x),
cesarean_rate.x = ifelse(is.na(cesarean_rate.x), cesarean_rate.y, cesarean_rate.x),
births.x = ifelse(is.na(births.x), births.y, births.x))
View(counties_3)
names(counties_3)
counties_3<- left_join(counties_2, county.pop) %>%
left_join(natality_counties, by=c("fips" = "County.Code")) %>%
left_join(unidentified, by = c("fips_state" = "state_code")) %>%
mutate(County.x = ifelse(is.na(County.x), County.y, County.x),
cesarean_rate.x = ifelse(is.na(cesarean_rate.x), cesarean_rate.y, cesarean_rate.x),
births.x = ifelse(is.na(births.x), births.y, births.x)) %>%
select(-County.Code, -County.y, -cesarean_rate.y, -births.y)
View(counties_3)
head(counties_3)
# check that we have cesarean rates for all counties with >100,000 2013 pop
unidentified_check<- filter(counties_3, POPESTIMATE2012<100000)
View(unidentified_check)
str(counties_3)
counties_3<- left_join(counties_2, county.pop) %>%
left_join(natality_counties, by=c("fips" = "County.Code")) %>%
left_join(unidentified, by = c("fips_state" = "state_code")) %>%
mutate(County.x = ifelse(is.na(County.x), County.y, County.x),
cesarean_rate.x = ifelse(is.na(cesarean_rate.x), cesarean_rate.y, cesarean_rate.x),
births.x = ifelse(is.na(births.x), births.y, births.x),
population = as.numeric(POPESTIMATE2012)) %>%
select(-County.Code, -County.y, -cesarean_rate.y, -births.y, -POPESTIMATE2012)
# check that we have cesarean rates for all counties with >100,000 2013 pop
unidentified_check<- filter(counties_3, population<100000)
View(unidentified_check)
table(unidentified_check$County.x)
# following stack overflow example
setwd("./counties_shapes/gz_2010_us_050_00_5m")
US.counties <- readOGR(dsn=".",layer="gz_2010_us_050_00_5m")
#leave out AK, HI, and PR (state FIPS: 02, 15, and 72)
US.counties <- US.counties[!(US.counties$STATE %in% c("02","15","72")),]
county.data <- US.counties@data
county.data <- cbind(id=rownames(county.data),county.data)
county.data[,FIPS:=paste0(STATE,COUNTY)] # this is the state + county FIPS code
setkey(county.data,FIPS)
county.data <- US.counties@data
county.data <- cbind(id=rownames(county.data),county.data)
county.data[,FIPS:=paste0(STATE,COUNTY)] # this is the state + county FIPS code
head(county.data)
county.data <- cbind(id=rownames(county.data),county.data) %>%
mutate(FIPS:=paste0(STATE,COUNTY))  # this is the state + county FIPS code
#leave out AK, HI, and PR (state FIPS: 02, 15, and 72)
US.counties <- US.counties[!(US.counties$STATE %in% c("02","15","72")),]
county.data <- US.counties@data
county.data <- cbind(id=rownames(county.data),county.data)
county.data[,FIPS:=paste0(STATE,COUNTY)] # this is the state + county FIPS code
